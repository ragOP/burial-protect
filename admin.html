<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Admin â€“ Live Alerts (Chime)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
    <style>
      :root { --bg:#0b0f17; --card:#121826; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; }
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
      header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #1f2937}
      .brand{font-weight:700}
      .container{max-width:1100px;margin:24px auto;padding:0 16px}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
      .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
      .card h3{margin:0 0 12px;font-size:18px}
      .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
      button,input{background:#0f172a;color:var(--text);border:1px solid #1f2937;padding:8px 10px;border-radius:10px;outline:none}
      button{cursor:pointer}
      button.primary{border-color:var(--accent)}
      button.ok{border-color:var(--ok)}
      button.warn{border-color:var(--warn)}
      input[type="text"]{width:100%}
      .inline{display:flex;gap:8px;align-items:center}
      .inline>*{flex:1}
      label{font-size:12px;color:var(--muted)}
      .events{max-height:60vh;overflow:auto;display:grid;gap:10px}
      .event{border:1px solid #1f2937;border-radius:12px;padding:10px;background:#0c1322}
      .event .meta{color:var(--muted);font-size:12px}
      .kvs{display:grid;grid-template-columns:90px 1fr;gap:8px;margin-top:6px}
      .k{color:var(--muted)}
      .v{word-break:break-word}
      .pill{padding:2px 8px;border-radius:999px;border:1px solid #1f2937;font-size:12px}
      .state{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
      .help{color:var(--muted);font-size:12px}
      @media (max-width:900px){.row{grid-template-columns:1fr}}
    </style>
  </head>
  <body>
    <header>
      <div class="brand">ðŸ”” Admin Alerts</div>
      <div class="state">
        <span id="socket-state" class="pill">Socket: â€¦</span>
        <span id="sound-state" class="pill">Sound: disabled</span>
      </div>
    </header>

    <div class="container">
      <div class="row">
        <div class="card">
          <h3>Sound Settings</h3>
          <div class="controls" style="margin-bottom:10px;">
            <button id="btn-enable" class="primary">Enable Sound</button>
            <button id="btn-test" class="ok">Test Sound</button>
            <button id="btn-mute" class="warn">Mute</button>
            <span style="width:160px" class="inline">
              <label for="vol">Volume</label>
              <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" />
            </span>
          </div>
          <div class="help">Chime will play <strong>only</strong> for events with type <code>call_click</code>.</div>
        </div>

        <div class="card">
          <h3>Connection</h3>
          <div style="display:grid; gap:8px;">
            <label for="socket-url">Socket Server URL</label>
            <div class="inline">
              <input id="socket-url" type="text" />
              <button id="btn-reconnect">Reconnect</button>
            </div>
            <div class="help">Example: <code>http://localhost:9005</code></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Recent Events</h3>
        <div id="events" class="events"></div>
      </div>
    </div>

    <!-- Use your local sound file in the SAME folder -->
    <audio id="chime" src="sound.mp3" preload="auto"></audio>

    <script>
      const DEFAULT_SOCKET_URL = "http://localhost:9005";
      let socket=null, soundEnabled=false, muted=false, volume=0.9;

      const elChime=document.getElementById("chime");
      const elSoundState=document.getElementById("sound-state");
      const elSocketState=document.getElementById("socket-state");
      const elEvents=document.getElementById("events");
      const elBtnEnable=document.getElementById("btn-enable");
      const elBtnTest=document.getElementById("btn-test");
      const elBtnMute=document.getElementById("btn-mute");
      const elVol=document.getElementById("vol");
      const elSocketUrl=document.getElementById("socket-url");
      const elBtnReconnect=document.getElementById("btn-reconnect");

      elSocketUrl.value = localStorage.getItem("admin_alerts_socket_url") || DEFAULT_SOCKET_URL;
      elVol.value = localStorage.getItem("admin_alerts_volume") || "0.9";
      volume = parseFloat(elVol.value);
      muted = localStorage.getItem("admin_alerts_muted") === "1";
      updateSoundState();

      function updateSoundState(){
        elSoundState.textContent = "Sound: " + (soundEnabled ? (muted ? "enabled (muted)" : "enabled") : "disabled");
      }

      async function playChime(){
        if(!soundEnabled) return;
        try{
          elChime.volume = muted ? 0 : volume;
          await elChime.play();
        }catch{
          // fallback beep
          try{
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const o=ctx.createOscillator(), g=ctx.createGain();
            o.type="sine"; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
            const base = muted?0.0:Math.max(0.0001, volume*0.2);
            g.gain.setValueAtTime(0.0001, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(base, ctx.currentTime+0.01);
            o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.18); o.stop(ctx.currentTime+0.2);
          }catch(e){ console.warn("WebAudio beep failed:", e); }
        }
      }

      function connectSocket(url){
        if(socket) try{ socket.close(); }catch{}
        elSocketState.textContent="Socket: connectingâ€¦";
        socket = io(url, { transports:["websocket"], withCredentials:true });
        socket.on("connect", ()=>{ elSocketState.textContent="Socket: connected ("+socket.id+")"; });
        socket.on("disconnect", (r)=>{ elSocketState.textContent="Socket: disconnected ("+r+")"; });
        socket.on("connect_error", (e)=>{ elSocketState.textContent="Socket: error"; console.error(e); });

        // Only chime on call_click
        socket.on("site:event", (payload)=>{
          renderEvent(payload);
          if (payload && payload.type === "call_click") {
            playChime();
          }
        });
      }

      function renderEvent(p){
        const card=document.createElement("div"); card.className="event";
        const when=new Date(p.at||Date.now()).toLocaleString();
        const meta=p.meta?JSON.stringify(p.meta,null,2):"{}";
        card.innerHTML = `
          <div class="meta">${when}</div>
          <div class="kvs">
            <div class="k">Type</div><div class="v">${esc(p.type||"unknown")}</div>
            <div class="k">Who</div><div class="v">${esc(p.who||"n/a")}</div>
            <div class="k">Meta</div><div class="v"><pre style="margin:0;white-space:pre-wrap">${esc(meta)}</pre></div>
          </div>`;
        elEvents.prepend(card);
      }
      function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

      // UI
      elBtnEnable.onclick = async () => {
        soundEnabled=true; updateSoundState();
        try{ elChime.volume=muted?0:volume; await elChime.play(); elChime.pause(); elChime.currentTime=0; }catch{}
      };
      elBtnTest.onclick = ()=>{ soundEnabled=true; updateSoundState(); playChime(); };
      elBtnMute.onclick = ()=>{ muted=!muted; localStorage.setItem("admin_alerts_muted", muted?"1":"0"); updateSoundState(); };
      elVol.oninput = ()=>{ volume=parseFloat(elVol.value); localStorage.setItem("admin_alerts_volume", String(volume)); };

      elBtnReconnect.onclick = ()=>{
        const url=(elSocketUrl.value||"").trim() || DEFAULT_SOCKET_URL;
        localStorage.setItem("admin_alerts_socket_url", url);
        connectSocket(url);
      };

      // boot
      connectSocket(elSocketUrl.value);
    </script>
  </body>
</html>
